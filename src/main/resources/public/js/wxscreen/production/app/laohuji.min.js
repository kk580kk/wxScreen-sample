!function (t) {
    if (!t.laohuji) {
        var e = t.laohuji = {
            _lotteryState: "stoped",
            _lottery_ids: [],
            _lotteryed_ids: [],
            _lottery_deleted_not_synced_ids: [],
            _lotteryed_not_synced_ids: [],
            _lotteryScrollTime: 1e4,
            _hided_user_ids: [],
            _tmp_lotteryed_ids: []
        };
        e.init = function (e, i) {
            this.appId = e, this._conf = i, this.preload(), this.bindEvent(), t.app.ready(this.appId), this.userReady(), this._inited || (this.lotteryPollNotSynced(), this._inited = !0)
        }, e.initDom = function () {
            this._lightBox = $("#js_lhjLightBox");
            var t = $("#js_lhjLightBox .pl4 li").length
            t -= 1;
            var e = $("#js_lhjLightBox .pl4 li").height();
            $.each($("#js_lhjLightBox .pl4 li"), function () {
                $(this).css({top: t * e + "px"}), t--
            })
        }, e.center = function () {
            var t = $(document).height();
            $("#js_lhjLayer").height(t), $("#js_lhjLayer").css("background-size", "cover");
            var e = $(".inner-lottery").height(), i = (t - e) / 2;
            i > 0 && $(".inner-lottery").css("top", i + "px"), $("#js_lhjLayer").css({
                width: "100%",
                left: 0,
                "margin-left": 0
            }), $("#js_lhjLayer .ele-spring").css({width: "100%", "background-size": "100%"})
        }, e.setLotteryUserNum = function () {
            var t = $("#js_lhjLotteryUserNum").val();
            this._lBox = $(".lhj-box-" + t), this._lBox.show().siblings(".box").hide(), this._scrollBoxList = this._lBox.find(".s-box"), this._scrollHOne = this._scrollBoxList.eq(0).find("img").height()
        }, e.setScrollUser = function () {
            var e, i = 1;
            $.each(this._scrollBoxList, function () {
                var r = $(this), o = 0, s = null, n = r.children().length;
                $.each(r.children(), function () {
                    if (o == n - 1)return s && $(this).attr("src", s.avatar).attr("data-user_id", s.id), !0;
                    try {
                        e = t.user._u.getDataByIndex(i)
                    } catch (r) {
                        e = !1
                    }
                    !e && i > 1 && (i = 1, e = t.user._u.getDataByIndex(i)), e && $(this).attr("src", e.avatar).attr("data-user_id", e.id), i++, 0 == o && e && (s = e), o++
                })
            })
        }, e.bindEvent = function () {
            t.sub(this.appId + ".show", function () {
                return t.getConf("isAdmin") || t.getConf("isDemo") ? (e.lotteryPull(), t.user.pull(), e.center(), e._user_all_ready ? (e.hideLoading(), e.initDom(), e.setLotteryUserNum()) : e.showLoading(), void 0) : (t.showMsg("登录后方可操作您的大屏幕"), void 0)
            }), t.sub(this.appId + ".hide", function () {
                e.lotteryPullStop()
            }), $("#js_lhjLotteryUserNum").change(function () {
                e.setLotteryUserNum()
            }), t.sub("key.enter.down", function () {
                e.appId == t.app.getCurrentId() && e.startLottery()
            }), $("#js_lhjStartBtn").click(function () {
                e.startLottery()
            }), $("#js_lhjClearBtn").click(function () {
                return e._resetLock ? void 0 : (e._resetLock = !0, confirm(t.template.get("lottery.reset_alert")) ? (e.lotteryReset(function (i) {
                    i && t.showMsg(i), e.initPrizeListScroll(), e._resetLock = !1
                }), void 0) : !1)
            }), $("#js_lhjHideLotteryBtn").click(function () {
                e.isOn() && e.hideLotteryScrollUser()
            }), $("#js_lhjShowLotteryBtn").click(function () {
                e.isOn() && e.showAllLotteryScrollUser()
            }), t.sub("key.72.down", function () {
                e.isOn() && e.hideLotteryScrollUser()
            }), t.sub("key.83.down", function () {
                e.isOn() && e.showAllLotteryScrollUser()
            }), $(window).on("resize", function () {
                e.center()
            })
        }, e.hideLotteryScrollUser = function () {
            var i;
            $.each($(".js_lhjPrizeList li"), function () {
                i = $(this).attr("data-user_id"), t.uniqueInsert(i, e._hided_user_ids)
            }), e.initPrizeListScroll()
        }, e.showAllLotteryScrollUser = function () {
            this._hided_user_ids = [], e.initPrizeListScroll()
        }, e.isOn = function () {
            return "app" == t.getState() && t.app.getCurrentId() == this.appId ? !0 : !1
        }, e.showLoading = function () {
            $(".js_lhjLoading").height($(document).height()), $(".js_lhjLoading").show()
        }, e.hideLoading = function () {
            $(".js_lhjLoading").hide()
        }, e.startLottery = function () {
            alert(this.lotteryGetIdsLength());
            if ("stoped" == this._lotteryState) {
                if (this.lotteryGetIdsLength() < parseInt($("#js_lhjLotteryUserNum").val()))return t.showMsg(t.template.get("lottery.no_user_alert")), void 0;
                this._tmp_lotteryed_ids = [], this._lotteryState = "lottery", $("#js_lhjLotteryUserNum").attr("disabled", "disabled"), this._lBox.find("li").removeClass("curr"), this.handMoving(function () {
                    e.lightMoving(1), e.startScrollBox()
                })
            } else"scrolling" == this._lotteryState || t.log("laohuji.startLottery failed:  _lotteryState=", this._lotteryState)
        }, e.startScrollBox = function () {
            for (var t = 0; t < this._scrollBoxList.length; t++) {
                var i = this._scrollBoxList.eq(t);
                i.data({last_duration: 1e3, start_top: 0, max_duration: 1800, children_num: i.children().length});
                var r = this.getScrollDuration(i), o = this.getEasing();
                this.scrollOne(this._scrollBoxList.eq(t), r, o, function () {
                    e.scrollCompleteOne($(this))
                })
            }
        }, e.getScrollDuration = function (t) {
            var e;
            return "stoping" == this._lotteryState ? e = t.data("last_duration") + 200 : (e = t.data("last_duration") - 200, 400 > e && (e = 400)), t.data("last_duration", e), e
        }, e.getEasing = function () {
            return "linear"
        }, e.scrollCompleteOne = function (t) {
            Modernizr.csstransitions ? t.css("y", 0) : t.css("top", -t.data("start_top"));
            var i = this.getScrollDuration(t);
            return i >= t.data("max_duration") ? (this.lotteryStoped(t), void 0) : (this.scrollOne(t, i, this.getEasing(), function () {
                e.scrollCompleteOne($(this))
            }), void 0)
        }, e.stopLottery = function () {
            this._lotteryState = "stoping", this._lotteryStopNum = 0
        }, e.lotteryStoped = function (i) {
            var r = this.lotteryRandom(), o = function () {
                e._lotteryStopNum++, e._lotteryStopNum == e._scrollBoxList.length && (e.lightMoving(2), e.colorRibbonMoving(), setTimeout(function () {
                    e.syncLotteryedUserFromDom()
                }, 0), $("#js_lhjLotteryUserNum").attr("disabled", !1))
            };
            r ? (t.uniqueInsert(r.id, this._tmp_lotteryed_ids), i.children().eq(1).attr("src", r.avatar).attr("data-user_id", r.id), this.scrollOne(i, i.data("max_duration") / i.data("children_num"), this.getEasing(), function () {
                o()
            }, this._scrollHOne)) : (t.log("laohuji.lotteryRandom failed"), i.children().eq(1).attr("src", i.children().eq(1).attr("data-def_src")).attr("data-user_id", 0), o())
        }, e.syncLotteryedUserFromDom = function () {
            var t = this._tmp_lotteryed_ids, i = function () {
                $(".js_lhjBoxAll .s-box img").attr("data-user_id", 0).attr("src", $(".js_lhjBoxAll .s-box img").attr("data-def_src")), e.initPrizeListScroll(), e.lightMovingStop(), e._lotteryState = "stoped"
            };
            t.length ? this.lotterySave(t, function () {
                setTimeout(function () {
                    i()
                }, 3e3)
            }) : i()
        }, e.preload = function () {
        }, e.scrollOne = function (e, i, r, o, s) {
            e = e.length > 1 ? e.eq(0) : e, r = r || "linear", i = i || 2e3, s = s || e.height() - this._scrollHOne, setTimeout(function () {
                Modernizr.csstransitions ? e.transition({y: -s}, i, r, o || t.loop) : e.animate({top: "-=" + s + "px"}, i, r, o || t.loop)
            }, 0)
        }, e.handMoving = function (t) {
            return this._handMovingLock ? void 0 : (this._handMovingLock = !0, this.setScrollUser(), Modernizr.csstransitions ? ($("#js_lhjStartBtn").css({
                transformOrigin: "0px 130px",
                rotateX: "0deg"
            }).transition({
                rotateX: "180deg", duration: 1600, easing: "easeOutExpo", complete: function () {
                    e._handMovingLock = !1, e.handStopMoving(t)
                }
            }), void 0) : (setTimeout(function () {
                t && t()
            }, 800), void 0))
        }, e.handStopMoving = function (t) {
            return this._handStopMovingLock ? void 0 : (this._handStopMovingLock = !0, Modernizr.csstransitions ? ($("#js_lhjStartBtn").transition({
                rotateX: "0deg",
                duration: 400,
                complete: function () {
                    e._handStopMovingLock = !1, setTimeout(function () {
                        e.stopLottery()
                    }, e._lotteryScrollTime / 2), t && t()
                }
            }), void 0) : (setTimeout(function () {
                t && t()
            }, 800), void 0))
        }, e.colorRibbonMoving = function () {
            $(".js_lhjColorRibbon").css({display: "block", scale: 0, opacity: 1}).transition({
                scale: 1.1,
                duration: 1200,
                opacity: .9,
                easing: "easeInOutExpo",
                complete: function () {
                    $(this).transition({
                        opacity: 0, complete: function () {
                            $(this).hide()
                        }
                    })
                }
            })
        }, e.lightMoving = function (t) {
            t = t || 1, this.lightMovingStop(), this.lightMovingOne(t), this._lightMovingTimer = setInterval(function () {
                e.lightMovingOne(t)
            }, 1 == t ? 110 : 500)
        }, e.lightMovingOne = function (t) {
            if (1 == t) {
                var e = this._lightBox.find("li").eq(this._lightStartIdx), i = this._lightBox.find("li").eq(++this._lightStartIdx);
                i.length || (i = this._lightBox.find("li").eq(0), this._lightStartIdx = 0), e.removeClass("light"), i.addClass("light")
            } else this._lightBox.find("li.light").length ? this._lightBox.find("li").removeClass("light") : this._lightBox.find("li").addClass("light")
        }, e.lightMovingStop = function () {
            clearInterval(this._lightMovingTimer), this._lightMovingTimer = null, this._lightBox.find("li.light").removeClass("light"), this._lightStartIdx = 0
        }, e.lotteryInitUser = function () {
            var e = t.parseVisibleTime("lottery");

            if (this._lottery_ids = [], t.user._whitelist_user.length)for (var i = 0; i < t.user._whitelist_user.length; i++) {
                var r = parseInt(t.user._whitelist_user[i].user_id);
                -1 == t.inArray(r, this._lotteryed_ids) && t.uniqueInsert(r, this._lottery_ids)
            } else for (var i = 0; i < t.user._ids.length; i++)t.user.isInTimeArr(t.user._ids[i], e) && -1 == t.inArray(t.user._ids[i], this._lotteryed_ids) && t.uniqueInsert(t.user._ids[i], this._lottery_ids);
            return !0
        }, e.lotteryGetIds = function () {
            this._firstGetLenInitLotteryUserFlag || (this.lotteryInitUser(), this._firstGetLenInitLotteryUserFlag = !0);
            for (var e, i = [], r = 0; r < this._lottery_ids.length; r++)e = this._lottery_ids[r], t.user._whitelist_user.length && t.user.inWhitelist(e) && -1 == t.inArray(e, this._lotteryed_ids) && -1 == t.inArray(e, this._lottery_deleted_not_synced_ids) ? i.push(e) : t.user._whitelist_user.length || -1 != t.inArray(e, this._lotteryed_ids) || -1 != t.inArray(e, this._lottery_deleted_not_synced_ids) || i.push(e);
            return i
        }, e.lotteryGetIdsLength = function () {
            var t = this.lotteryGetIds();
            return t.length
        }, e.lotteryRandom = function () {
            var e = this._lottery_ids.length - 1;
            if (0 > e)return !1;
            var i, r = this.lotteryGetIds();
            if (!r.length)return t.log("lhj.lotteryRandom failed: t_lottery_ids empty"), !1;
            for (var o = [], s = 0; s < r.length; s++)-1 == t.inArray(r[s], this._tmp_lotteryed_ids) && o.push(r[s]);
            if (!o.length)return t.log("lhj.lotteryRandom failed: lottery_ids empty"), !1;
            i = o[t.rand(0, o.length - 1)];
            var n = t.user.info(i);
            return n ? n : (t.log("lhj.lotteryRandom getElemByPointer failed uid=", i), !1)
        }, e.initPrizeListScroll = function (i) {
            i = i === !1 ? !1 : !0, $(".js_lhjPrizeList").trigger("destroy");
            for (var r = "", o = 0; o < this._lotteryed_ids.length; o++) {
                var s = this._lotteryed_ids[o], n = t.user.info(s);
                n ? -1 == t.inArray(s, e._hided_user_ids) ? r += '<li data-user_id="' + s + '">                 <a href="###" class="with-avatar"><img src="' + n.avatar + '" alt=""></a>                 <p>' + n.name + "</p>               </li>" : t.log("lhj.initPrizeListScroll user.info in _hided_user_ids: ", s) : t.log("lhj.initPrizeListScroll user.info failed:", s)
            }
            $(".js_lhjPrizeList").html(r).carouFredSel({
                circular: !1,
                items: 5,
                prev: ".js_lhjPrevBtn",
                next: ".js_lhjNextBtn",
                auto: {play: !0, pauseDuration: 2e4},
                mousewheel: !0,
                scroll: {items: 5, duration: 1e3, pauseOnHover: !0}
            }), i && $(".js_lhjPrizeList").trigger("slideTo", ".js_lhjPrizeList li:last")
        }, e.lotteryPullStop = function () {
            return clearTimeout(this._lotteryPullTimer), this._lotteryPullAjaxObj && (this._lotteryPullAjaxObj.abort(), this._lotteryPullAjaxObj = null), this
        }, e.lotteryPull = function () {
            return this.lotteryPullStop(), t.getConf("isDemo") ? (this._lotteryPullTimer = setTimeout(function () {
                e._lottery_user_ready || (e._lottery_user_ready = !0), e._user_ready && e._whitelist_user_ready && t.pub("laohuji.user_all_ready")
            }, 1e3), !1) : (this.lotterySync(function () {
                e._lottery_user_ready || (e._lottery_user_ready = !0), e._user_ready && e._whitelist_user_ready && t.pub("laohuji.user_all_ready"), e.isOn() && (e._lotteryPullTimer = setTimeout(function () {
                    e.lotteryPull()
                }, 1e3 * t.rand(3, 5)))
            }), void 0)
        }, e.lotterySync = function (i) {
            i = i || t.loop;
            var r = this;
            r._lotteryPullAjaxObj = $.post(t.url("lottery/sync?type=laohuji"), function (t) {
                var o = null, s = null;
                if ("ok" == t.info) {
                    if (!r._lottery_deleted_not_synced_ids.length && !r._lotteryed_not_synced_ids.length) {
                        var n = !0;
                        r._lotteryed_ids = t.ids, t.ids.length && r._lotteryed_ids.length == t.ids.length && r._lotteryed_ids[r._lotteryed_ids.length - 1] == t.ids[t.ids.length - 1] && (n = !1), n && e.initPrizeListScroll(!1)
                    }
                    o = !0
                } else s = t.info;
                i(s, o)
            }, "json").error(function (e, r) {
                e.readyState < 2 && "error" == r && t.pub("network.disconnected", e), i("lhj.lotterySync: ajax-error")
            })
        }, e.lotterySave = function (e, i, r) {
            i = i || t.loop;
            var o = this;
            e instanceof Array || (e = [e]);
            var s = function () {
                for (var r = 0; r < e.length; r++)t.uniqueInsert(e[r], o._lotteryed_ids), t.deleteByElem(e[r], o._lottery_ids);
                i(null, !0)
            };
           // if (t.getConf("isDemo"))return s(), void 0;
            for (var n = 0; n < e.length; n++)t.uniqueInsert(e[n], o._lotteryed_not_synced_ids);
            r ? (t.log("user.lotterySave-notice: quickSave = true"), s()) : ($.ajax({
                type: "POST",
                url: t.url("lottery/lottery_save?type=laohuji"),
                data: {user: e},
                dataType: "json",
                timeout: 1e4,
                success: function (i) {
                    if ("ok" == i.info)for (var r = 0; r < e.length; r++)t.deleteByElem(e[r], o._lotteryed_not_synced_ids)
                },
                error: function (e, i) {
                    e.readyState < 2 && "error" == i && t.pub("network.disconnected", e)
                }
            }), setTimeout(function () {
                s()
            }, 10))
        }, e.lotteryDelete = function (e, i) {
            var r = this, o = function () {
                t.deleteByElem(e, r._lotteryed_ids), t.deleteByElem(e, r._lotteryed_not_synced_ids), t.uniqueInsert(e, r._lottery_ids), i(null, !0)
            };
            return t.getConf("isDemo") ? (o(), void 0) : (t.uniqueInsert(e, r._lottery_deleted_not_synced_ids), $.post(t.url("lottery/del_win_user?type=laohuji"), {id: e}, function (i) {
                "ok" == i.info && t.deleteByElem(e, r._lottery_deleted_not_synced_ids), o()
            }, "json").error(function (e, i) {
                e.readyState < 2 && "error" == i && t.pub("network.disconnected", e)
            }), setTimeout(function () {
                o()
            }, 10), void 0)
        }, e.lotteryReset = function (e) {
            e = e || t.loop;
            var i = this, r = function () {
                i._lotteryed_ids = [], i._lotteryed_not_synced_ids = [], i.lotteryInitUser(), t.pub("reset_last_whitelist_id", 0), e(null, !0)
            };
            return t.getConf("isDemo") ? (r(), void 0) : ($.post(t.url("lottery/lottery_reset?type=laohuji"), function (e) {
                if ("ok" != e.info)for (var o = 0; o < i._lotteryed_ids.length; o++)t.uniqueInsert(i._lotteryed_ids[o], i._lottery_deleted_not_synced_ids);
                r()
            }, "json").error(function (e, o) {
                for (var s = 0; s < i._lotteryed_ids.length; s++)t.uniqueInsert(i._lotteryed_ids[s], i._lottery_deleted_not_synced_ids);
                r(), e.readyState < 2 && "error" == o && t.pub("network.disconnected", e)
            }), void 0)
        }, e.lotteryPollNotSynced = function () {
            var e = this;
            clearInterval(this._lotteryPullNotSyncTimer), this._lotteryPullNotSyncTimer = setInterval(function () {
                if (e._lotteryed_not_synced_ids.length || e._lottery_deleted_not_synced_ids.length) {
                    var i = e._lottery_deleted_not_synced_ids.concat(), r = e._lotteryed_not_synced_ids.concat();
                    $.post(t.url("lottery/lottery_not_synced?type=laohuji"), {
                        deleted: i.join(","),
                        lotteryed: r.join(",")
                    }, function (o) {
                        if ("ok" == o.info) {
                            for (var s = 0; s < i.length; s++)t.deleteByElem(i[s], e._lottery_deleted_not_synced_ids);
                            for (var s = 0; s < r.length; s++)t.deleteByElem(r[s], e._lotteryed_not_synced_ids)
                        } else t.DEBUG && t.log("user.lotteryPollNotSynced failed:", o)
                    }, "json").error(function (e, i) {
                        t.DEBUG && t.log("user.lotteryPollNotSynced failed: ajax-error"), e.readyState < 2 && "error" == i && t.pub("network.disconnected", e)
                    })
                }
            }, 7e3)
        }, e.userReady = function () {
            t.subOnce("laohuji.user_all_ready", function () {
                e._user_all_ready = !0, e.isOn() && (e.hideLoading(), e.initDom(), e.setLotteryUserNum(), e.lotteryInitUser(), e.initPrizeListScroll(), t.user.pull())
            }), t.user._user_ready ? this._user_ready = 1 : t.sub("user.ready", function () {
                e._user_ready = 1, e._whitelist_user_ready && e._lottery_user_ready && t.pub("laohuji.user_all_ready")
            }), t.user._whitelist_user_ready ? this._whitelist_user_ready = 1 : t.sub("user.whitelist.ready", function () {
                e._whitelist_user_ready = 1, e._user_ready && e._lottery_user_ready && t.pub("laohuji.user_all_ready")
            }), this._user_ready && this._whitelist_user_ready && this._lottery_user_ready && t.pub("laohuji.user_all_ready")
        }
    }
}(wxscreen);