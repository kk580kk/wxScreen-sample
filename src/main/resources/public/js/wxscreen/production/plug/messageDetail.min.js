!function (e) {
    if (!e.messageDetail) {
        var t = e.messageDetail = {_textBoxW: null, _textBoxH: null};
        t.init = function () {
            this._box = $(".messageDetailBox"), this._listBox = $(".messageDetailList"), this._currentId = 0, this._scrollWidth = 0, this._scrollState = "stoped", this._scrollSpeed = 400;
            var e = '      <div class="mayer-box hidden imageDetailLayer"></div>      <div style="display:none;" class="imgdetail imageDetailbox">        <div class="imgbox">          <a href="javascript:void(0);" class="flbtn-close imageDetailCloseBtn"></a>        </div>      </div>';
            $("#wrap").append(e), this.bindEvent(), this.subEvent()
        }, t.renderOne = function (t) {
            var s = "";
            if (!t)return s;
            var a, i, r = !!t.photo_small, l = "v6_lost" == e.getConf("template"), n = "sms" == t.message_from ? e.template.get("message.detail_msg_from_sms") : e.template.get("message.detail_msg_from_weixin");
            if (r)a = "", i = '        <div class="artZoomBox" style="min-width: 230px;">          <div class="tool" style="z-index: 1;min-width: 230px;">            <a class="viewImg" href="javascript:;" title="' + e.template.get("message.detail_img_show_ori") + '">' + e.template.get("message.detail_img_show_ori") + '</a>            <a class="imgLeft" href="javascript:;" title="' + e.template.get("message.detail_img_turn_left") + '">' + e.template.get("message.detail_img_turn_left") + '</a>            <a class="imgRight" href="javascript:;" title="' + e.template.get("message.detail_img_turn_right") + '">' + e.template.get("message.detail_img_turn_right") + '</a>          </div>          <a class="">            <img class="messageDetailImage maxImg" src="' + t.photo_ori + '" style="cursor:pointer;' + (l ? "max-width:426px;max-height:552px;" : "") + '">          </a>        </div>', e.loadImage(t.photo_ori); else {
                var o = this.fontSize(t.content) + "px";
                i = "", a = '<p class="detail-cont messageDetailContent" style="font-size:' + o + ';">' + t.content + "</p>"
            }
            return s += "v6_lost" == e.getConf("template") ? '        <div class="detail-bar clearfix" style="cursor: default;" data-id="' + t.id + '">              <div class="info-part left">                <a href="###" class="img-wrap"><img src="' + t.avatar + '" width="100" height="100" alt=""></a>                <a href="###" class="user-name-round">' + t.username + '</a>                <a href="###" class="sub-logo"><img src="' + e.getConf("siteUrl") + '/images/v6_lost/logo_lost2.png" alt=""></a>              </div>              <div class="cont-part left">                ' + a + '                <div class="imgb-show">                  ' + i + "                </div>              </div>          </div>" : '        <div class="detail-bar" style="cursor: default;" data-id="' + t.id + '">          <div class="detail-top clearfix">			<div class="userimg left">			  <i class="elem"></i>			  <span class="elem2"></span>			  <a href="javascript:;" class="head messageOneAvatar"><img src="' + t.avatar + '" width="90" height="90" alt=""></a>			</div>            <p class="detail-info">              <a href="javascript:;" class="user-name-detail messageOneName">' + t.username + ':</a>              <span class="messageDetailIntroLabel">' + n + "</span>            </p>          </div>          " + a + '          <div class="imgb-show">            ' + i + "          </div>        </div>"
        }, t.scrollCheck = function () {
            return "running" == this._scrollState ? !1 : this._currentId ? !0 : !1
        }, t.renderScroll = function (e, t) {
            if (!e || !e.length)return !1;
            if (e[0].id == this._currentId)return !1;
            var s = Math.abs(this._listBox.attr("data-to") || 0) / this._scrollWidth, a = this._listBox.children(":eq(" + s + ")");
            if (!a || !a.length)return !1;
            for (var i = "", r = 0; r < e.length; r++)i += this.renderOne(e[r]);
            return i ? (a.nextAll().remove(), a.prevAll().remove(), this.scrollFn(this._listBox, 0, 0), "prev" == t ? (a.before(i), this.scrollFn(this._listBox, -e.length * this._scrollWidth, 0), this.scrollFn(this._listBox, 0)) : (a.after(i), this.scrollFn(this._listBox, -e.length * this._scrollWidth)), this) : !1
        }, t.scrollPrev = function () {
            if (!this.scrollCheck())return !1;
            e.message.setScrollType("prev");
            var t = e.message.prev(1);
            if (t)return this.renderScroll([t.data], "prev")
        }, t.scrollNext = function (t) {
            if (!this.scrollCheck())return !1;
            e.message.setScrollType("next", t);
            var s = e.message.next(1);
            if (s)return this.renderScroll([s.data], "next")
        }, t.scrollNewest = function () {
            if (!this.scrollCheck())return !1;
            e.message.setScrollType("newest");
            var t = e.message.newest(1);
            if (t)return this.renderScroll([t.data], "next")
        }, t.scrollOldest = function () {
            if (!this.scrollCheck())return !1;
            e.message.setScrollType("oldest");
            var t = e.message.oldest(1);
            if (t)return this.renderScroll([t.data], "prev")
        }, t.scrollFn = function (t, s, a) {
            var i = this, r = "animate";
            e.message._transitions && (r = "translate"), e.message.pause(), t.attr("data-to", s), this._scrollState = "running", i[r](t, s, a)
        }, t.translate = function (e, t, s) {
            s = "undefined" == typeof s ? this._scrollSpeed : s;
            var a = this;
            return 0 == s ? e.css({x: t + "px"}) : e.transition({x: t + "px"}, s, function () {
                a.afterScrollEnd()
            }), this
        }, t.animate = function (e, t, s) {
            if (0 === s)return e.css("left", t + "px"), this;
            var a = this;
            return s = "undefined" == typeof s ? this._scrollSpeed : s, e.animate({left: t}, s, function () {
                a.afterScrollEnd()
            }), this
        }, t.afterScrollEnd = function () {
            this._scrollState = "stoped";
            var t = this._listBox.attr("data-to") || 0, s = Math.abs(t) / this._scrollWidth;
            this._currentId = this._listBox.children(":eq(" + s + ")").attr("data-id"), e.pub("messageDetail.afterScrollEnd"), e.message.resume()
        }, t.fontSize = function (t) {
            if (!t)return 15;
            -1 != t.indexOf("<img") && (t = t.replace(/\<img.+?\>/g, "11")), -1 != t.indexOf("<img") && (t = t.replace(/\<img.+?\>/g, "") ? t.replace(/\<img.+?\>/g, "11") : ""), -1 != t.indexOf("<span") && -1 != t.indexOf("emoji") && (t = t.replace(/<span.+?emoji.+?><\/span>/g, "") ? t.replace(/<span.+?emoji.+?><\/span>/g, "11") : "");
            var s = 60, a = 292400;
            fontNum = e.fontNum(t);
            var i = Math.sqrt(a / fontNum) / 1.6;
            return i > s ? s : i
        }, t.show = function (t) {
            var s = e.progress.state;
            e.message.pause(), e.setState("messageDetail"), e.message.pull();
            var a = this.renderOne(t);
            this._listBox.html(a), this.scrollFn(this._listBox, 0, 0), e.message.setViewIds([t.id]);
            var i = this;
            this._box.fadeIn("fast", function () {
                i._scrollWidth = e._width(i._listBox.children(":eq(0)")), i.afterScrollEnd(), "running" != s ? e.message.pause() : e.progress.restart()
            })
        }, t.hide = function () {
            var t = e.progress.state;
            e.setState("message"), "running" != t ? e.message.pause() : e.progress.restart(), e.message.initView()
        }, t.autoScale = function (t) {
            if (!t)return !1;
            var s = t.attr("src"), a = t.attr("data-width"), i = t.attr("data-height"), r = t.attr("data-rotate") || 0, l = Math.abs(r) / 90 % 2 == 0 ? 0 : 1, n = parseInt($.css(t[0], "max-width")) || 800, o = parseInt($.css(t[0], "max-height")) || 340, c = function () {
                if (t.attr("data-width", a), t.attr("data-height", i), !(n > a && o > i)) {
                    var e = a, s = i, r = e / s, c = 1;
                    e > n && (e = n, s = e / r), s > o && (s = o, e = s * r), 1 == l && (c = n / s, c * e > o && (c = o / e)), t.css({
                        width: e + "px",
                        height: s + "px",
                        scale: c
                    }).removeClass("maxImg")
                }
            };
            return a && i ? (c(), void 0) : (e.loadImage(s, function (e, t, s) {
                return e ? !1 : (a = s.width, i = s.height, c(), void 0)
            }), void 0)
        }, t.bindEvent = function () {
            var t = this;
            $(".scrollBox").delegate("li", "click", function () {
                var s = $(this).closest("li").attr("data-id");
                if (!s)return !1;
                var a = e.message.info(s);
                if (!a) {
                    var i = $(this).find(".msgImage"), r = i.length ? i.attr("src") : "";
                    a = {
                        id: s,
                        username: $(this).find(".msgUserName").html().replace(/:$/, ""),
                        avatar: $(this).find(".msgAvatar").attr("src"),
                        photo_ori: r,
                        photo_small: r,
                        content: $(this).find(".displayContent").html()
                    }
                }
                t.show(a)
            }), $(".scrollBox").delegate("li", "mouseenter", function () {
                $(this).children(".messageDetailBtn").show()
            }), $(".scrollBox").delegate("li", "mouseleave", function () {
                $(this).children(".messageDetailBtn").hide()
            }), this._box.hover(function () {
                $(".messageDetailCloseBtn").show()
            }, function () {
                $(".messageDetailCloseBtn").hide()
            }), $(".messageDetailCloseBtn").click(function () {
                t.hide()
            }), $(".messageDetailBox").delegate(".imgLeft", "click", function () {
                var e = $(this).closest(".artZoomBox").find(".messageDetailImage"), s = parseInt(e.attr("data-rotate")) || 0;
                360 == Math.abs(s) && (s = 0), s -= 90, e.attr("data-rotate", s), e.css({rotate: s + "deg"}), t.autoScale(e)
            }), $(".messageDetailBox").delegate(".imgRight", "click", function () {
                var e = $(this).closest(".artZoomBox").find(".messageDetailImage"), s = parseInt(e.attr("data-rotate")) || 0;
                360 == Math.abs(s) && (s = 0), s += 90, e.attr("data-rotate", s), e.css({rotate: s + "deg"}), t.autoScale(e)
            }), $(".messageDetailBox").delegate(".viewImg", "click", function () {
                e.message.pause();
                var t, s, a, i = $(this).closest(".artZoomBox").find(".messageDetailImage"), r = i.attr("src"), l = i.attr("data-rotate") || 0, n = Math.abs(l) / 90 % 2 == 0 ? 0 : 1, o = 1, c = $(window).width(), g = $(window).height();
                t = i.attr("data-width"), s = i.attr("data-height");
                var d = function () {
                    a = t / s, t > c && (t = c, s = t / a), s > g && (s = g, t = s * a), 1 == n && (o = c / s, o * t > g && (o = g / t));
                    var e = (g - s) / 2, i = '<img class="imageDetailElem" src="' + r + '" style="width:' + t + "px;height:" + s + "px;margin-top:" + e + 'px" />';
                    $(".imageDetailbox .imgbox").append(i), $(".imageDetailLayer").show(), $(".imageDetailbox").show(), $(".imageDetailbox .imgbox img").css({rotate: l + "deg"})
                };
                return t && s ? (d(), void 0) : (e.loadImage(r, function (e, a, r) {
                    return e ? !1 : (t = r.width, s = r.height, i.attr("data-width", t), i.attr("data-height", s), d(), void 0)
                }), void 0)
            }), $(".messageDetailBox").delegate(".messageDetailImage", "click", function () {
                $(this).closest(".artZoomBox").find(".viewImg").trigger("click")
            }), $(".messageDetailBox").delegate(".artZoomBox", "mouseenter", function () {
                $(this).addClass("js_hover")
            }), $(".messageDetailBox").delegate(".artZoomBox", "mouseleave", function () {
                $(this).removeClass("js_hover")
            }), $(".imageDetailCloseBtn").click(function () {
                $(".imageDetailLayer").hide(), $(".imageDetailbox").hide(), $(".imageDetailbox .imgbox img:last").remove()
            }), $(".imageDetailElem").live("click", function () {
                $(".imageDetailCloseBtn").trigger("click")
            }), $(".imageDetailbox .imgbox").hover(function () {
                $(".imageDetailCloseBtn").show()
            }, function () {
                $(".imageDetailCloseBtn").hide()
            })
        }, t.off = function () {
            this._currentId = null, "messageDetail" == e.getState() && (e.message.pause(), this._box.fadeOut("fast"))
        }, t.subEvent = function () {
            var t = this;
            e.sub("control.btn.btnNewest.clicked", function () {
                "messageDetail" == e.getState() && ("running" == e.progress.state && e.progress.restart(), t.scrollNewest())
            }), e.sub("control.btn.btnOldest.clicked", function () {
                "messageDetail" == e.getState() && ("running" == e.progress.state && e.progress.restart(), t.scrollOldest())
            }), e.sub("control.btn.btnNext.clicked, key.right.down", function () {
                "messageDetail" == e.getState() && ("running" == e.progress.state && e.progress.restart(), t.scrollNext())
            }), e.sub("control.btn.btnPrev.clicked, key.left.down", function () {
                "messageDetail" == e.getState() && ("running" == e.progress.state && e.progress.restart(), t.scrollPrev())
            }), e.sub("event.progress.compelete", function () {
                "messageDetail" == e.getState() && t.scrollNext("progress.compelete")
            })
        }
    }
}(wxscreen);