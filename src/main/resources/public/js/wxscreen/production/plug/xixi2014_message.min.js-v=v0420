!function (e) {
    if (e.xixi2014_message)return !1;
    var i = {
        playTime: 5e3,
        popupDisplay: 1500,
        speedView: 200,
        speedRemove: 400,
        speedTitle: 400,
        _flip_moving: ["flip", "turn", "cross", "diagonal", "rotate"],
        _state: {
            0: "头像区域为空，初始状态",
            1: "已经添加了新的签到用户,等待翻牌",
            4: "翻牌动画进行中",
            5: "已经翻牌完毕，等待展示气泡",
            9: "气泡动画展示中",
            10: "气泡展示完毕，等待新签到的人替换"
        }
    }, s = e.xixi2014_message = {};
    s._isLoaded = !1, s._xixi2014_messageBox = null, s._xixi2014_messageLayer = null, s._liW = 63, s._liH = 63, s._screenW = $(window).width(), s._screenH = $(window).height(), s._scaleX = s._liW / s._screenW, s._scaleY = s._liH / s._screenH, s._lockedDetail = !1, s._config = i, s._playTimer = null, s._lockedLoad = !1, s.setPlayTime = function (i, s) {
        i && (this._config.playTime = i, clearInterval(this._playTimer), this._playTimer = setInterval(function () {
            e.pub("xixi2014.message.next")
        }, this._config.playTime)), s && (this._config.popupDisplay = s)
    }, s.clear = function () {
        clearInterval(this._playTimer);
        var i = this.renderOne();
        this._xixi2014_messageBox.find("li.xixi2014_messageMessageBox").html(i), this._xixi2014_messageBox.find("li.xixi2014_messageMessageBox").attr("data-state", 0), e.message.setViewIds([]), this._playTimer = setInterval(function () {
            e.pub("xixi2014.message.next")
        }, this._config.playTime)
    }, s.init = function () {
        var s = this;
        s._xixi2014_messageBox = $("#xixi2014_messageBox"), s._xixi2014_messageLayer = $("#xixi2014_messageLayer"), e.setConf("stepTime", 40), e.message.addProxy(s), $(".btnOldest, .btnPrev, .btnPause, .btnNext, .btnNewest, #cirProgress").hide(), e.message._hideTooltip = !0, this._config.playTime = 1e3 * e.getConf("autoTime") + 2e3, this._config.popupDisplay = 1e3 * e.getConf("autoTime"), e.subOnce("message.loadComplete", function () {
            e.message.off(!0), s.initDom(), s.bindEvent(), setTimeout(function () {
                s._isLoaded = !0, e.setState("message")
            }, 400)
        }), s._playTimer = setInterval(function () {
            e.pub("xixi2014.message.next")
        }, i.playTime)
    }, s.initDom = function () {
        var i = this, t = !1;
        if (window.localStorage) {
            var a = "xixi2014_message-dom-1-" + e.getConf("companyId"), o = localStorage.getItem(a);
            if (o) {
                var n = Math.ceil((new Date).getTime() / 1e3);
                o = JSON.parse(o), n - o.time <= 300 && (t = !0, i._xixi2014_messageBox.html(o.html))
            }
        }
        if (!t) {
            var l = s.renderOne();
            this._xixi2014_messageBox.find("li.xixi2014_messageMessageBox").html(l), this._xixi2014_messageBox.find("li.xixi2014_messageMessageBox").attr("data-state", 0), e.message.setViewIds([])
        }
    }, s.getLiSize = function (e, i) {
        return i ? e.height() : e.width()
    }, s.renderOne = function (e, i) {
        var s = "";
        e && (s += "width:" + e + "px;"), i && (s += "height:" + i + "px;");
        var t = '        <!--div class="user-block in" data-id="0" style="' + s + '">           <div class="xixi2014_messageAvatarBox">             <a href="javascript:void(0);"><img class="checkin-avatar xixi2014_messageAvatar cki-default" src="/images/v6_xixi2014/checkin_default.jpg"></a>             <span class="checkin-name xixi2014_messageName"></span>           </div>         </div -->         <div class="user-block out" data-id="0" style="' + s + '">           <div class="xixi2014_messageAvatarBox">             <a href="javascript:void(0);"><img class="checkin-avatar xixi2014_messageAvatar cki-default" src="/images/v6_xixi2014/checkin_default.jpg"></a>             <span class="checkin-name xixi2014_messageName"></span>           </div>         </div>';
        return t
    }, s.on = function () {
        this.show(), e.progress.restart(), e.message.pull()
    }, s.off = function () {
        this.hide()
    }, s.isOn = function () {
        return "message" == e.getState() && e.message.getProxyObj() == this
    }, s.show = function () {
        return this._isLoaded ? (this._xixi2014_messageLayer.css("visibility", "visible"), void 0) : !1
    }, s.hide = function () {
        this._xixi2014_messageLayer.css("visibility", "hidden")
    }, s.addOneToDom = function (i) {
        var s = this, t = function (i, s) {
            if (!i.length)return e.DEBUG && e.log("xixi2014.addOneToDom failed: no dom place to store"), s && s("xixi2014.addOneToDom failed: no dom place to store", null), !1;
            if (0 == e.message.length())return e.DEBUG && e.log("xixi2014.addOneToDom failed: no new user"), s && s(null, "no_user"), void 0;
            var t = e.message.next();
            if (!t)return e.log("xixi2014.addOneToDom failed: g.message.next() return false"), !1;
            newMessage = t.data;
            var a = $(i[0]);
            a.attr("data-state", 1).attr("data-msg-id", newMessage.id), s && s(null, a, newMessage)
        }, a = this._xixi2014_messageBox.find('li.xixi2014_messageMessageBox[data-state="0"]');
        a.length || (a = s._xixi2014_messageBox.find('li.xixi2014_messageMessageBox[data-state="10"]'), a.length || e.throwErr('li.xixi2014_messageMessageBox[data-state="10"] not found')), t(a, i)
    }, s.showOne = function () {
        var s = this;
        this.addOneToDom(function (t, a) {
            return a ? ("no_user" != a && s.showDetail(a, function (t) {
                return t ? (e.log("showDetail call err:", t), void 0) : (setTimeout(function () {
                    s.hideDetail(a, function () {
                        19 == a.index() ? $("li.xixi2014_messageMessageBox").attr("data-state", 0) : a.attr("data-state", 10), s.syncToLocal()
                    })
                }, i.popupDisplay), void 0)
            }), void 0) : (e.DEBUG && e.log("xixi2014.showOne failed: addOneToDom return false"), void 0)
        })
    }, s.showDetail = function (i, s) {
        var t = i.attr("data-msg-id"), a = e.message.info(t);
        if (!a)return s && s("xixi2014.showDetail failed: msg empty"), e.log("xixi2014.showDetail failed: msg empty"), void 0;
        var o = a.photo ? !0 : !1;
        o ? this.showImg(i, a, s) : this.showMsg(i, a, s)
    }, s.hideDetail = function (i, s) {
        var t = i.attr("data-msg-id"), a = e.message.info(t);
        if (!a)return e.log("xixi2014.hideDetail failed: msg empty"), s && s("xixi2014.hideDetail failed: msg empty"), void 0;
        var o = a.photo ? !0 : !1;
        o ? this.hideImg(i, a, s) : this.hideMsg(i, a, s)
    }, s.showImg = function (i, s, t) {
        var a, o, n, l = s.photo_ori, r = this, d = 1, x = $(window).width(), m = $(window).height(), c = function (e) {
            if (e)return t && t(), void 0;
            n = a / o, a > x && (a = x, o = a / n), o > m && (o = m, a = o * n), d = x / o, d * a > m && (d = m / a);
            var i = (m - o) / 2, s = '<img src="' + l + '" style="width:' + a + "px;height:" + o + "px;margin-top:" + i + 'px" />';
            $("#xixi2014ImgDetailbox .imgbox").html(s), $("#xixi2014DetailMayer").show(), $("#xixi2014ImgDetailbox").css({
                transformOrigin: "0 0",
                display: "block",
                scale: 0,
                left: 0,
                top: 0
            }).transition({
                duration: 300, scale: 1, left: 0, top: 0, complete: function () {
                    t && t()
                }
            })
        };
        return a && o ? (c(), void 0) : (r._lockedLoad = !0, e.loadImage(l, function (e, i, s) {
            return r._lockedLoad = !1, e ? (c("err"), void 0) : (a = s.width, o = s.height, c(), void 0)
        }), void 0)
    }, s.hideImg = function (e, i, s) {
        var t = this, a = e.offset();
        $("#xixi2014DetailMayer").hide(), $("#xixi2014ImgDetailbox").css({transformOrigin: "0 0"}).transition({
            duration: 300,
            scale: t._scaleX,
            left: a.left,
            top: a.top,
            complete: function () {
                $("#xixi2014ImgDetailbox").css({scale: 0, top: 0, left: 0});
                var t = e.find(".xixi2014_messageAvatar");
                t.attr("src", i.avatar).removeClass("cki-default"), s && s()
            }
        })
    }, s.showMsg = function (e, i, s) {
        $("#xixi2014MsgDetailBox .msgBox").html(this.renderDetailMsg(i)), $("#xixi2014MsgDetailBox").css({
            transformOrigin: "0 0",
            display: "block",
            scale: 0,
            left: ($(window).width() - 1022) / 2,
            top: 0
        }).transition({
            duration: 300, scale: 1, complete: function () {
                s && s()
            }
        })
    }, s.hideMsg = function (e, i, s) {
        var t = this, a = e.offset();
        $("#xixi2014MsgDetailBox").css({transformOrigin: "0 0"}).transition({
            duration: 300,
            scale: t._scaleX,
            left: a.left,
            top: a.top,
            complete: function () {
                $("#xixi2014MsgDetailBox").css({
                    scale: 0,
                    top: 0,
                    left: 0
                }), e.find(".xixi2014_messageAvatar").attr("src", i.avatar).removeClass("cki-default").css({
                    width: t._liW,
                    height: t._liH
                }), s && s()
            }
        })
    }, s.renderDetailMsg = function (i) {
        var s = "sms" == i.message_from ? e.template.get("message.detail_msg_from_sms") : e.template.get("message.detail_msg_from_weixin"), t = this.fontSize(i.content) + "px", a = '<p class="detail-cont xixi2014MsgDetailContent" style="font-size:' + t + ';">' + i.content + "</p>";
        return html = '        <div class="detail-bar" style="cursor: default;" data-id="' + i.id + '">          <div class="detail-top clearfix">            <div class="userimg left">              <i class="elem"></i>              <span class="elem2"></span>              <a href="javascript:;" class="head"><img src="' + i.avatar + '" width="90" height="90" alt=""></a>            </div>            <p class="detail-info">              <a href="javascript:;" class="user-name-detail">' + i.username + ":</a>              <span>" + s + "</span>            </p>          </div>          " + a + "        </div>"
    }, s.fontSize = function (i) {
        if (!i)return 15;
        -1 != i.indexOf("<img") && (i = i.replace(/\<img.+?\>/g, "11")), -1 != i.indexOf("<img") && (i = i.replace(/\<img.+?\>/g, "") ? i.replace(/\<img.+?\>/g, "11") : ""), -1 != i.indexOf("<span") && -1 != i.indexOf("emoji") && (i = i.replace(/<span.+?emoji.+?><\/span>/g, "") ? i.replace(/<span.+?emoji.+?><\/span>/g, "11") : "");
        var s = 100, t = 578200;
        fontNum = e.fontNum(i);
        var a = Math.sqrt(t / fontNum) / 1.6;
        return a > s ? s : a
    }, s.bindEvent = function () {
        var i = this;
        e.sub("xixi2014.message.next", function () {
            !i.isOn() || i._lockedDetail || i._lockedLoad || i.showOne("progress.compelete")
        }), e.sub("message.pull.empty", function () {
            if (window.localStorage) {
                var s = "xixi2014_message-dom-5-" + e.getConf("companyId");
                localStorage.removeItem(s)
            }
            i.initDom(), e.progress.restart()
        }), $("li.xixi2014_messageMessageBox").click(function () {
            if (i._lockedDetail)return e.log("xixi2014: detailLocked"), void 0;
            var s = $(this);
            i._lockedDetail = s, i.showDetail(s, function (s) {
                s && (i._lockedDetail = !1), e.log("xixi2014: user showDetail complete!, err:", s)
            })
        }), $("#xixi2014ImgDetailbox, #xixi2014MsgDetailBox").click(function () {
            i._lockedDetail && i.hideDetail(i._lockedDetail, function (s) {
                s && e.log("xixi2014.hideDetail call failed:", s), i._lockedDetail = !1
            })
        }), e.sub("key.76.down", function (e, s) {
            s.ctrlKey && i.clear()
        })
    }, s.getFontSize = function (i) {
        var s = 60, t = 230, a = 492;
        i = e.trim(i), -1 != i.indexOf("<img") && (i = i.replace(/\<img.+?\>/g, "") ? i.replace(/\<img.+?\>/g, "11") : ""), -1 != i.indexOf("<span") && -1 != i.indexOf("emoji") && (i = i.replace(/<span.+?emoji.+?><\/span>/g, "") ? i.replace(/<span.+?emoji.+?><\/span>/g, "11") : "");
        var o = e.fontNum(i);
        if (!o)return s;
        var n = Math.sqrt(a * t / o) / 1.4;
        return n > s && (n = s), n
    }, s.getSharpClassName = function (e) {
        var i = "leftside", s = e.position();
        return 0 == s.top ? i = "topside" : s.top > 440 ? i = "bottomside" : s.left > 427 && (i = "rightside"), i
    }, s.showPop = function (s) {
        var t = s.find(".user-block.in"), a = (t.find(".xixi2014_messageAvatar"), t.find(".xixi2014_messageAvatarBox")), o = parseInt(t.attr("data-id")), n = e.message.info(o);
        if (!n)return e.log("xixi2014.showPop failed: get messageData failed"), !1;
        var l = n.content, r = this.getFontSize(l), d = n.photo_ori ? !0 : !1;
        d && (l = '<img src="' + n.photo_ori + '" class="xixi2014_message-user-photo" style="max-height: 260px;max-width: 445px;width: auto;height: auto;">'), s.css({"z-index": "10"}), s.addClass("hover");
        var x = -(100 - this.getLiSize(s)) / 2;
        if (s.hasClass("special") && t.find(".xixi2014_messageAvatar").css({height: "auto"}), t.find(".xixi2014_messageName").show(i.speedView), a.css("position", "relative"), a.stop().animate({
                marginTop: x + "px",
                marginLeft: x + "px",
                width: "100px",
                height: "100px",
                padding: "0px"
            }, {
                duration: i.speedView, compelete: function () {
                }
            }), 0 != l.length) {
            t.find(".xixi2014_messageWords").length ? t.find(".xixi2014_messageTitle").html(l) : t.prepend('<div class="xixi2014_messageWords checkin-words"><div> <i>  </i><pre><span class="xixi2014_messageTitle">' + l + "</span></pre></div></div>");
            var m = t.find(".xixi2014_messageWords"), c = 0;
            if (d ? c = 492 : (m.css("position", "absolute").children("div").css("width", "auto"), c = m.children("div").width()), m.css("position", "static").children("div").css("width", c), d)var g = '<p><span class="xixi2014_messageTitle" style="max-height:260px;height:260px;">' + l + "</span></p>"; else var g = '<p><span class="xixi2014_messageTitle">' + l + "</span></p>";
            m.find("pre").remove(), m.find("i").after(g), d ? m.show().find(".xixi2014_messageTitle").css("text-align", "center") : m.show().find(".xixi2014_messageTitle").css("font-size", r);
            var f = m.height(), p = c + 4, h = 100, u = 100, v = 3, _ = this.getSharpClassName(s);
            if (m.find("i").addClass(_), "topside" == _ || "bottomside" == _) {
                var w = (p - 30) / 2 - 20;
                m.find("i").css("left", w + "px")
            }
            var D = 0, y = 0;
            "leftside" == _ || "leftside2" == _ ? (D = h - 10, y = -46) : "rightside" == _ || "rightside2" == _ ? (D = -p - v - 46, y = -46) : "bottomside" == _ ? (D = -(p - h) / 2 - 15, y = -f - v - 46) : "topside" == _ && (D = -(p - h) / 2 - 15, y = u), m.closest("li").attr("data-state", "9");
            var T = this;
            m.animate({left: D + "px", top: y + "px"}, {
                duration: i.speedTitle, complete: function () {
                    var e = $(this);
                    T.completePop(e)
                }
            }).css({"z-index": "10", position: "absolute", "float": "left"})
        }
    }, s.completePop = function (e, s) {
        var t = this, a = e.closest("li"), o = a.find(".user-block.in");
        s = void 0 === s ? i.popupDisplay : 0, setTimeout(function () {
            e.closest("li").attr("data-state", "10"), a.css({"z-index": "8"}), a.removeClass("hover");
            var s = t.getLiSize(a);
            o.find(".xixi2014_messageName").hide(), o.find(".xixi2014_messageAvatarBox").stop().animate({
                marginTop: "0",
                marginLeft: "0",
                top: "0",
                left: "0",
                width: s + "px",
                height: s + "px",
                padding: "0px"
            }, {
                duration: i.speedRemove, complete: function () {
                    a.hasClass("special") && o.find(".xixi2014_messageAvatar").css({height: "31px"}), a.hasClass("hm60") && t._xixi2014_messageBox.find("li.xixi2014_messageMessageBox").attr("data-state", 0), t._xixi2014_messageBox.find(".user-block").removeClass(i._flip_moving.join(" ")), t.syncToLocal()
                }
            }), o.find(".xixi2014_messageWords").remove()
        }, s)
    }, s.randomFlipMoving = function (s) {
        var t = s.find(".user-block"), a = i._flip_moving[e.rand(0, i._flip_moving.length - 1)];
        $.each(t, function () {
            $(this).removeClass(i._flip_moving.join(" ")).addClass(a)
        })
    }, s.flip = function (e, i) {
        var s = e.find(".user-block.in"), t = e.find(".user-block.out");
        return e.attr("data-state", 4), s.removeClass("in out"), t.removeClass("in out"), this.randomFlipMoving(e), s.addClass("out").removeClass("in"), setTimeout(function () {
            var a = t.find(".xixi2014_messageAvatar");
            a.attr("src", a.attr("data-src")), t.addClass("in").removeClass("out").css("z-index", 10), s.css("z-index", 0), setTimeout(function () {
                e.attr("data-state", 5), i && i(null, e)
            }, 150)
        }, 125), this
    }, s.syncToLocal = function () {
        if (!window.localStorage)return e.log("xixi2014.syncToLocal failed localStorage is not supported"), !1;
        var i = {};
        i.html = this._xixi2014_messageBox.html(), i.time = Math.ceil((new Date).getTime() / 1e3), i = JSON.stringify(i);
        var s = "xixi2014_message-dom-1-" + e.getConf("companyId");
        localStorage.setItem(s, i)
    }
}(wxscreen);