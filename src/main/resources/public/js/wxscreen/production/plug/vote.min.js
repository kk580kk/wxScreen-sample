!function (t) {
    if (t.vote)return !1;
    var o = t.vote = {};
    o._voteInfo = null, o._prevVoteInfo = null, o._barMap = ["", "progress-bar-first", "progress-bar-second", "progress-bar-third"], o._timer = null, o._ajaxObj = null, o._eventInited = !1, o._optPerPage = 12, o.init = function (o) {
        return this._prevVoteInfo = this._voteInfo, this._voteInfo = o, this._voteInfo ? ($(".voteClosedBox").hide(), $(".voteOpendBox").show(), this.render(), this.center(), this.renderShowResultType()) : ($(".voteClosedBox").show(), $(".voteOpendBox").hide(), t.DEBUG && t.log("vote.init failed: voteInfo is empty")), this._eventInited || this.initEvent(), this
    }, o.renderShowResultType = function () {
        1 == this._voteInfo.show_result_type ? ($(".voteOptionP").show(), $(".voteOptionCount").closest("span").show(), $(".voteJoinNum").parent().show()) : 2 == this._voteInfo.show_result_type ? ($(".voteOptionP").show(), $(".voteOptionCount").closest("span").hide(), $(".voteJoinNum").parent().hide()) : 3 == this._voteInfo.show_result_type ? ($(".voteOptionP").hide(), $(".voteOptionCount").closest("span").show(), $(".voteJoinNum").parent().show()) : 4 == this._voteInfo.show_result_type && ($(".voteOptionP").hide(), $(".voteOptionCount").closest("span").hide(), $(".voteJoinNum").parent().hide())
    }, o.render = function () {
        return $(".voteTitle").html(this._voteInfo.title), $(".voteIntro").html(this._voteInfo.intro), $(".voteJoinNum").text(this._voteInfo.join_count), this.renderOption(), this.bindOptDetailEvent(), this
    }, o.bindOptDetailEvent = function () {
        var t, o = this;
        t = 1 == this._voteInfo.has_image ? $(".voteImageOptionBox li") : $(".voteOptionBox li"), t.unbind().bind("click", function () {
            var t = parseInt($(this).attr("data-id"));
            t && o.showOptDetail(t)
        }), this._bindOptDetailInited || (this._bindOptDetailInited = !0, $(".js_voteBack").click(function () {
            $(".voteOpendBox .votewrap").show(), $("#js_vdetailBox").hide()
        }))
    }, o.showOptDetail = function (o) {
        var e = this._voteInfo ? this._voteInfo.id : !1;
        if (e) {
            for (var i, n = 0; n < this._voteInfo.option_list.length; n++)if (this._voteInfo.option_list[n].id == o) {
                i = this._voteInfo.option_list[n];
                break
            }
            if (i) {
                var s = "";
                s = i.option_image_url && i.option_image ? '<img width="32" height="32" src="' + i.option_image_url + '" />' : i.option_content, $("#js_vdetailBox .js_voteOptTit").html("“" + s + "”"), $("#js_vdetailBox .js_voteOptUsertotal").html(" " + i.option_count + " "), $("#js_vdtData").html("");
                var r = $("#js_vdetailBox").find(".js_vdetailPrev"), a = $("#js_vdetailBox").find(".js_vdetailNext"), v = this, l = function () {
                    var i = $(this), n = parseInt($(this).attr("data-page_no"));
                    return 0 >= n ? (t.log("vote option detail page_no <= 0"), void 0) : i.hasClass("loading-btn") ? (t.log("vote clickFn loading..."), void 0) : (i.addClass("loading-btn"), $(".voteOpendBox .votewrap").hide(), $("#js_vdetailBox").show(), v.getVoteUserList({
                        page_no: n,
                        vote_id: e,
                        option_id: o,
                        num: v._optPerPage
                    }, function (o, e) {
                        if (i.removeClass("loading-btn"), o)return t.showMsg(o), void 0;
                        if (e.list.length >= v._optPerPage) {
                            var s = n + 1, l = n - 1;
                            0 > l && (l = 0), a.attr("data-page_no", s), r.attr("data-page_no", l)
                        }
                        {
                            var h = i.hasClass("js_vdetailPrev") ? "prev" : "next";
                            v.renderOptDetail(n, e.list, h)
                        }
                    }), void 0)
                };
                r.attr("data-page_no", 0).unbind("click").bind("click", l), a.attr("data-page_no", 1).unbind("click").bind("click", l), a.trigger("click")
            }
        }
    }, o.renderOptDetail = function (o, e, i) {
        if (!e || !e.length)return t.showMsg("投票用户加载完毕"), !1;
        for (var n = '<div class="vdetail-list clearfix js_voScroll" data-page="' + o + '">', s = 0; s < e.length; s++)n += '        <div class="v-item" data-id="' + e[s].id + '">          <div class="vavatar"><img src="' + e[s].avatar + '" alt=""></div>          <p class="vname">' + e[s].user_name + "</p>        </div>";
        n += "</div>", n = $(n);
        var r = $("#js_vdtData"), a = r.parent().width();
        return 0 == r.children().length || r.find(".js_voScroll").attr("data-page") == o || r.find(".js_voScroll").children().length < this._optPerPage ? (n.css("x", 0), r.html("").append(n)) : "next" == i ? (n.css("x", a), r.append(n), n.transition({x: 0}), n.prev().transition({
            x: -a,
            complete: function () {
                $(this).remove()
            }
        })) : "prev" == i && (n.css("x", -a), r.prepend(n), n.transition({x: 0}), n.next().transition({
            x: a,
            complete: function () {
                $(this).remove()
            }
        })), e.length < this._optPerPage && t.showMsg("投票用户加载完毕"), !0
    }, o.getVoteUserList = function (o, e) {
        $.getJSON(t.url("vote/get_option_user"), o, function (t) {
            "ok" != t.info ? e && e(t.info) : e && e(null, t)
        }).error(function () {
            e && e("网络错误")
        })
    }, o.renderOption = function () {
        if (1 == this._voteInfo.has_image)return this.renderImageOption();
        $(".voteImageOptionBox").hide();
        var o = $(".voteOptionBox");
        o.show();
        var e = this, i = this._voteInfo.option_list.length, n = [];
        if (this._prevVoteInfo && this._prevVoteInfo.has_image == this._voteInfo.has_image && i == this._prevVoteInfo.option_list.length) {
            for (var s = !1, r = 0; i > r; r++)if (this._voteInfo.option_list[r].id != this._prevVoteInfo.option_list[r].id) {
                s = !0;
                break
            }
            if (!s) {
                for (var r = 0; i > r; r++)this.renderOptionOne(this._voteInfo.option_list[r], !0, this._prevVoteInfo.option_list[r]);
                return this
            }
        }
        $.each(this._voteInfo.option_list, function (t) {
            this.viewOrder = t + 1, n.push(e.renderOptionOne(this))
        });
        var a = 0, v = 0, l = [], h = 0, p = 0;
        if ($(".optionRow ul:eq(0)").html(""), $(".optionRow ul:eq(1)").html(""), $(".optionRow ul:eq(2)").html(""), 5 >= i ? (v = 1, p = 5) : 10 >= i ? (v = 2, p = 5) : 15 >= i ? (v = 3, p = 5) : (v = 3, p = 6), v) {
            a = 0;
            for (var r = 1; r <= n.length && (l[a] || (l[a] = 0), l[a]++, l[a] >= p && a++, !(a >= v)); r++);
        }
        return t.DEBUG && t.log("vote.render boxNums:", l), h = 0, $.each(l, function (t, o) {
            return o ? ($(".optionRow ul:eq(" + t + ")").html(n.slice(h, h + o).join("")), h += o, void 0) : !1
        }), this.resetViewOrder(), o.removeClass("one-row two-row three-row three-row-five").addClass(this.getOptionClass()), this
    }, o.renderImageOption = function () {
        $(".voteOptionBox").hide();
        var t = $(".voteImageOptionBox");
        t.show();
        var o = this, e = this._voteInfo.option_list.length, i = [];
        if (this._prevVoteInfo && this._prevVoteInfo.has_image == this._voteInfo.has_image && e == this._prevVoteInfo.option_list.length) {
            for (var n = !1, s = 0; e > s; s++)if (this._voteInfo.option_list[s].id != this._prevVoteInfo.option_list[s].id) {
                n = !0;
                break
            }
            if (!n) {
                for (var s = 0; e > s; s++)this.renderImageOptionOne(this._voteInfo.option_list[s], !0, this._prevVoteInfo.option_list[s]);
                return this.imageCenter(), this
            }
        }
        $.each(this._voteInfo.option_list, function (t) {
            this.viewOrder = t + 1, i.push(o.renderImageOptionOne(this))
        });
        return t.find("ul.vote-img-list").html(""), 2 >= e ? (t.children(".two-item").show().siblings().hide(), t.children(".two-item").find("ul.vote-img-list").html(i.join(""))) : (t.children(".eight-item").show().siblings().hide(), t.children(".eight-item").find("ul.vote-img-list").html(i.join(""))), this.imageCenter(), this.resetViewOrder(), this
    }, o.resetViewOrder = function () {
        var t = 1;
        if (this._voteInfo.has_image) {
            var o;
            o = this._voteInfo.option_list.length <= 2 ? $(".voteImageOptionBox .two-row ul.vote-img-list") : $(".voteImageOptionBox .eight-row ul.vote-img-list"), $.each(o.children("li"), function () {
                $(this).find(".voteViewOrder").text(vieworder++)
            })
        } else $.each($(".optionRow ul:eq(0)").children("li"), function () {
            $(this).find(".voteViewOrder").text(t++)
        }), $.each($(".optionRow ul:eq(1)").children("li"), function () {
            $(this).find(".voteViewOrder").text(t++)
        }), $.each($(".optionRow ul:eq(2)").children("li"), function () {
            $(this).find(".voteViewOrder").text(t++)
        })
    }, o.renderImageOptionOne = function (o, e, i) {
        var n = this._barMap[parseInt(o.rank)] || "", s = parseInt(this._voteInfo.vote_count && o.option_count) ? (o.option_count / this._voteInfo.vote_count * 100).toFixed(1) : 0;
        if (e) {
            var r = parseInt(this._prevVoteInfo.vote_count && i.option_count) ? (i.option_count / this._prevVoteInfo.vote_count * 100).toFixed(1) : 0, a = i.option_count, v = o.option_count, l = $('.voteImageOptionBox li[data-id="' + o.id + '"]');
            if (!l || !l.length)return t.DEBUG && t.log("vote.renderOptionOne error: update failed, option dom not exists."), !1;
            var h = l.find(".voteOptionBar");
            l.find(".voteImageOne img").attr("src", o.option_image_url), l.find(".voteOptionTitle").html(o.option_content), l.find(".voteOptionP").text(s + "%"), l.find(".voteOptionCount").text(o.option_count), h.removeClass($.trim(this._barMap.join(" "))).addClass(n), (r != s || a != v) && (h.css({width: 0}), setTimeout(function () {
                h.animate({width: s + "%"})
            }, 400));
            var p = l.find(".voteOptionP").parent(), d = p.width();
            return p.width(d + 1).hide().width(d).css("zoom", 1).show(), !0
        }
        var c = '            <li data-id="' + o.id + '">               <p class="with-map2 voteImageOne"><img src="' + o.option_image_url + '" alt=""></p>               <span class="votenum voteViewOrder">' + o.viewOrder + '</span>               <div class="example">                 <p class="vote-topic voteOptionTitle">' + o.option_content + '</p>                 <div class="progress">                   <div class="progress-bar voteOptionBar ' + n + '" style="width:' + s + '%;">                     <p class="words-tips"><span class="sr-only voteOptionP">' + s + '%</span><span> <em class="voteOptionCount">' + o.option_count + "</em>票</span></p>                   </div>                 </div>               </div>             </li>";
        return c
    }, o.imageCenter = function () {
        var t = $(".voteImageOptionBox .voteImageOne img"), o = this;
        $.each(t, function () {
            o.imageCenterOne($(this))
        })
    }, o.imageCenterOne = function (o) {
        t.loadImage(o.attr("src"), function (e, i, n) {
            if (e)return t.log("vote.imageCenterOne failed: img not exists", e), void 0;
            var s, r, a = n.width, v = n.height, l = a, h = v, p = o.parent().width(), d = o.parent().height();
            a = p, v = h * a / l, s = (d - v) / 2, r = 0, v > d && (v = d, a = l * v / h, s = 0, r = (p - a) / 2), o.css({
                width: a + "px",
                height: v + "px",
                left: r + "px",
                top: s + "px",
                position: "absolute"
            }).parent().css("position", "relative")
        })
    }, o.renderOptionOne = function (o, e, i) {
        var n = this._barMap[parseInt(o.rank)] || "", s = parseInt(this._voteInfo.vote_count && o.option_count) ? (o.option_count / this._voteInfo.vote_count * 100).toFixed(1) : 0;
        if (e) {
            var r = parseInt(this._prevVoteInfo.vote_count && i.option_count) ? (i.option_count / this._prevVoteInfo.vote_count * 100).toFixed(1) : 0, a = $('.voteOptionBox li[data-id="' + o.id + '"]');
            if (!a || !a.length)return t.DEBUG && t.log("vote.renderOptionOne error: update failed, option dom not exists."), !1;
            var v = a.find(".voteOptionBar");
            return a.find(".voteOptionTitle").html(o.option_content), a.find(".voteOptionP").text(s + "%"), a.find(".voteOptionCount").text(o.option_count), v.removeClass($.trim(this._barMap.join(" "))).addClass(n), r != s && (v.css({width: 0}), setTimeout(function () {
                v.animate({width: s + "%"})
            }, 400)), !0
        }
        var l = '            <li class="clearfix" data-id="' + o.id + '">              <span class="votenum voteViewOrder">' + o.viewOrder + '</span>              <div class="example">                <p class="vote-topic voteOptionTitle">' + o.option_content + '</p>                <div class="progress">                  <div class="progress-bar voteOptionBar ' + n + '" style="width:' + s + '%;">                    <p class="words-tips"><span class="sr-only voteOptionP">' + s + '%</span><span> <em class="voteOptionCount">' + o.option_count + "</em>票</span></p>                  </div>                </div>              </div>            </li>";
        return l
    }, o.getOptionClass = function () {
        var t = this._voteInfo.option_list.length;
        return 5 >= t ? "one-row" : 10 >= t ? "two-row" : 15 >= t ? "three-row-five" : "three-row"
    }, o.sync = function () {
        if (this._ajaxObj) {
            try {
                this._ajaxObj.abort()
            } catch (o) {
                t.DEBUG && t.log("vote.sync: _ajaxObj.abort error")
            }
            this._ajaxObj = null
        }
        var e = this;
        this._ajaxObj = $.post(t.url("vote/current"), function (o) {
            "ok" != o.info ? t.showMsg(o.info) : e.init(o.vote_info)
        }, "json").error(function (o, e) {
            t.DEBUG && t.log("vote.sync failed: ajax-error", e)
        })
    }, o.poll = function () {
        this.pollStop();
        var t = this;
        this._timer = setInterval(function () {
            t.sync()
        }, 5e3)
    }, o.pollStop = function () {
        return clearInterval(this._timer), this._timer = null, this
    }, o.on = function () {
        this.sync(), $("#vote_layer").fadeIn(), this.poll();
        try {
            t.ddp && t.ddp.off(), t.lottery && t.lottery.off()
        } catch (o) {
            t.DEBUG && t.log("vote.on off other failed", o)
        }
    }, o.off = function () {
        $("#vote_layer").hide(), this.pollStop()
    }, o.show = function () {
        t.setState("vote")
    }, o.hide = function () {
        t.setState("message")
    }, o.initEvent = function () {
        var o = this;
        $(".btnVote").click(function () {
            return t.getConf("votePlug") ? ($("#vote_layer:visible").length ? o.hide() : o.show(), void 0) : (t.showMsg("您还没有开通投票功能，详情咨询客服"), void 0)
        }), $(".voteCloseBtn").click(function () {
            o.hide()
        }), t.sub("key.84.down", function () {
            $(".btnVote").trigger("click")
        }), this._eventInited = !0
    }, o.center = function () {
        var o, e = $(".optionRow ul:eq(0)").find("li"), i = t._height(e.eq(0)), n = i * e.length;
        o = this._voteInfo.option_list.length <= 10 ? 5 * i : 6 * i;
        var s = 0;
        return o > n && (s = (370 - n) / 2), $(".voteOptionBox").css({"margin-top": s + "px"}), this
    }
}(wxscreen);