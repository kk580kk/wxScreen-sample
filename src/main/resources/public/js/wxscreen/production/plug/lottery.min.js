! function(t) {
    function e() {
        a(), r(), t.getConf("isAdmin") || t.getConf("isDemo") ? ($(".resetLotteryBtn, .startLotteryBtn, #lotteryNumBox").show(), $("#slaveScreenLotteryTip").hide()) : ($(".resetLotteryBtn, .startLotteryBtn, #lotteryNumBox").hide(), $("#slaveScreenLotteryTip").show())
    }

    function r() {
        t.sub("user.synced", function() {
            t.user._isReady && h(t.user.lotteryGetIdsLength())
        }), t.sub("user.lotterySynced", function() {
            alert(t.user.lotteryGetIdsLength());
            t.user._isReady && (h(t.user.lotteryGetIdsLength()), t.user._is_main_screen || t.getConf("isDemo") || t.getConf("isAdmin") ? g() : t.lottery.initPlay())
        }), t.subOnce("user.all_ready", function() {
            alert('all_ready');

            $(".startLotteryBtn").children("span").text(t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start")), t.btnLoading($(".resetLotteryBtn"), "hide"), t.btnLoading($(".resetAllLotteryBtn"), "hide"), h(t.user.lotteryGetIdsLength()), g(), $(".startLotteryBtn").click(function(e) {
                if (e && e.preventDefault() && e.preventDefault(), !t.getConf("isAdmin") && !t.getConf("isDemo")) return t.DEBUG && t.log("lottery startLotteryBtn: isAdmin=false, return"), !1;
                if (b) return t.DEBUG && t.log("startLotteryBtn clicked but todoLotteryLock = true, return false"), t.showMsg(t.template.get("lottery.lottery_busy")), void 0;
                if (w === !1) {
                    if (B > 0) return t.showMsg(t.template.get("lottery.lottery_busy")), t.DEBUG && t.log("startLotteryBtn clicked but todoLotteryUserNum > 0 , return false"), void 0;
                    B = parseInt($("#lotteryNumSel").val()) || 1, s()
                } else b = !0, o()
            }), $("#resetLotteryBtn, .resetAllLotteryBtn").click(function(e, r) {
                if (!t.getConf("isAdmin") && !t.getConf("isDemo")) return t.DEBUG && t.log("lottery resetLotteryBtn: isAdmin=false, return"), !1;
                if (b) return t.showMsg(t.template.get("lottery.lottery_busy")), void 0;
                var a = $(this);
                if ("yes" == a.attr("data-disabled")) return t.showMsg(t.template.get("lottery.in_reset_alert")), !1;
                if (!(r && "yaokongqi" == r.source || confirm(t.template.get("lottery.reset_alert")))) return !1;
                a.attr("data-disabled", "yes"), t.btnLoading(a, "show");
                var i = _._award_category_id;
                a.hasClass("resetAllLotteryBtn") && (i = void 0), t.user.lotteryReset(function(e) {
                    return t.btnLoading(a, "hide"), a.attr("data-disabled", "no"), e ? t.showMsg(e) : (g(), h(t.user.lotteryGetIdsLength()), d(), void 0)
                }, i)
            })
        }), t.sub("key.enter.down", function(e, r) {
            return t.getConf("isAdmin") || t.getConf("isDemo") ? ("lottery" == t.getState() && (r.preventDefault(), setTimeout(function() {
                $(".startLotteryBtn").trigger("click")
            }, 0)), void 0) : (t.DEBUG && t.log("lottery enter keydown: isAdmin=false, return"), !1)
        })
    }

    function a() {
        $(".btnLottery").click(function() {
            return t.getConf("lotteryPlug") ? (n(), void 0) : (alert(t.template.get("lottery.not_opened")), void 0)
        }), t.sub("key.67.down", function() {
            $(".btnLottery").trigger("click"), t.getConf("isAdmin") && (clearTimeout(x), x = null, I && (I.abort(), I = null), x = setTimeout(function() {
                I = $.get(t.url("message/screen_state"), {}, function(e) {
                    t.DEBUG && t.log(e)
                }).error(function(e, r) {
                    t.DEBUG && t.log("screenStateAjaxObj error:", e, r)
                })
            }, 800))
        })
    }

    function i() {
        $(".winUserList li").unbind(), $(".delWinUser").unbind(), $(".winUserList li").hover(function() {
            return t.getConf("isAdmin") || t.getConf("isDemo") ? (b || $(this).children(".delWinUser").toggle(), void 0) : (t.DEBUG && t.log("winUserList li hover return false"), !1)
        }), $(".delWinUser").click(function() {
            var e = $(this).attr("data-id");
            if (!e) return !1;
            if (b) return t.showMsg(t.template.get("lottery.lottery_busy")), void 0;
            if (!confirm(t.template.get("lottery.delete_alert"))) return !1;
            $(this);
            t.user.lotteryDelete(e, function(r) {
                return r ? t.showMsg(json.info) : ($('.winUserList li[data-id="' + e + '"]').fadeOut(function() {
                    $('.winUserList li[data-id="' + e + '"]').remove(), g(), h(t.user.lotteryGetIdsLength());
                    var r = $(".lotteryLayer .lotteryName").attr("data-id");
                    r == e && d()
                }), void 0)
            })
        })
    }

    function n() {
        $(".lotteryLayer:visible").length ? t.setState("message") : t.setState("lottery")
    }

    function s() {
        return t.user.lotteryGetIdsLength() <= 0 ? (B = 0, t.showMsg(t.template.get("lottery.no_user_alert")), !1) : "yes" == $(".startLotteryBtn").attr("data-disabled") ? (t.showMsg(t.template.get("lottery.save_last_data")), !1) : ($(".startLotteryBtn").children("span").text(t.template.get("lottery.stopBtnText") || t.template.get("lottery.stop")), p = setInterval(function() {
            y(u())
        }, 50), w = !0, !0)
    }

    function o() {
        if (clearInterval(p), p = null, B > 0 && 2 == t.getConf("lotteryAnimationDisplayType")) {
            for (var e = 0; B > e; e++) {
                if (t.user.lotteryGetIdsLength() <= 0) {
                    t.showMsg(t.template.get("lottery.no_user_alert")), B = 0, b = !1, w = !1;
                    var r = t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start");
                    $(".startLotteryBtn").children("span").text(r);
                    break
                }
                var a = t.user.lotteryRandom();
                L = a, l(a, !0)
            }
            y(L), B = 0, b = !1, w = !1;
            var r = t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start");
            return $(".startLotteryBtn").children("span").text(r), void 0
        }
        y(L), l(), B--, w = !1;
        var r = t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start");
        if (r = r + "(" + B + ")", $(".startLotteryBtn").children("span").text(r), B > 0) 1 == t.getConf("lotteryAnimationDisplayType") && setTimeout(function() {
            var e = s();
            if (e) setTimeout(function() {
                o()
            }, 2e3);
            else {
                B = 0, b = !1;
                var r = t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start");
                $(".startLotteryBtn").children("span").text(r)
            }
        }, 2e3);
        else {
            b = !1;
            var r = t.template.get("lottery.startBtnText") || t.template.get("lottery.lottery_start");
            $(".startLotteryBtn").children("span").text(r)
        }
    }

    function l(e, r, a) {
        if (e) var i = {
            id: e.id,
            avatar: e.avatar,
            name: e.name,
            mobile: e.mobile
        };
        else var i = {
            id: L.id,
            avatar: L.avatar,
            name: L.name,
            mobile: L.mobile
        };
        var n = $(".startLotteryBtn");
        n.attr("data-disabled", "yes"), r || t.btnLoading(n, "show"), t.user.lotterySave(i.id, function(e) {
            return r || n.attr("data-disabled", "no"), t.btnLoading(n, "hide"), g(i), h(t.user.lotteryGetIdsLength()), e ? t.showMsg(e) : (a && a(), void 0)
        }, r, _._award_category_id)
    }

    function d() {
        $(".lotteryLayer .lotteryImg").attr("src", $(".lotteryLayer .lotteryImg").data("default_src")), $(".lotteryLayer .lotteryName").text("... ..."), L = null
    }

    function y(e) {
        return e ? ($(".lotteryLayer .lotteryImg").attr("src", e.avatar), $(".lotteryLayer .lotteryName").html(e.name).attr("data-id", e.id), v || (L = e), void 0) : (t.log("lottery: _displayUser userInfo empty"), !1)
    }

    function u() {
        var e = t.user.lotteryRandom();
        return L && e.id == L.id ? (e = t.user.random(), v = !0) : v = !1, e
    }

    function g(e) {
        var r = "",
            a = t.user.getAwardLotteryedIds(_._award_category_id);
        console.log('获奖人员');
        console.log(a);
        if (e) r = f(e), $(".winUserList").prepend(r), $(".winUserList").parent().scrollTop(0);
        else {
            for (var n = !1, s = a.length - 1; s >= 0; s--) {
                var o = t.user.info(a[s]);
                o ? ($('.winUserList li[data-id="' + o.id + '"]').length || (n = !0), r += f(o)) : t.log("in lottery _renderWinUser foreach user get false.")
            }(n || !a.length || !t.user._is_main_screen && !t.getConf("isDemo")) && $(".winUserList").html(r)
        }
        if (m(a.length), i(), c(), !t.getConf("isAdmin") && !t.getConf("isDemo")) {
            var l = $(".winUserList li:eq(0)");
            if (l.length) {
                var u = t.user.info(l.data("id"));
                u && y(u)
            } else d()
        }
    }

    function f(t) {
        var e = _._conf.is_show_win_mobile ? '<p class="tel left">' + t.mobile + "</p>" : "",
            r = '      <li class="clearfix" data-id="' + t.id + '">        <p class="head-part left">          <span class="num-p winUserRankNum"><em></em></span>          <a href="javascript:;"><img width="50" height="50" src="' + t.avatar + '" alt=""></a>        </p>        <a href="javascript:;" class="nick-name left winUserName">' + t.name + "</a>        " + e + '         <a href="javascript:void(0);" class="del delWinUser" data-id="' + t.id + '">×</a>      </li>';
        return r
    }

    function c() {
        var t = $(".winUserList li"),
            e = t.length;
        $.each(t, function(t) {
            $(this).find(".winUserRankNum em").text(e - t)
        })
    }

    function h(t) {
        $(".lotteryLayer .lotteryUserNum").text(t)
    }

    function m(t) {
        $(".lotteryLayer .winUserNum").text(t)
    }
    if (!t.lottery) {
        var _ = t.lottery = {
            _lotterySlaveTimer: null,
            _playIsInited: !1,
            _playedIdx: -1,
            _playList: [],
            _playeTimer: null
        };
        _.init = function(t) {
            this._conf = t
        }, _.off = function() {
            t.user._isReady && t.user.lotteryPullStop(), $(".lotteryLayer").hide()
        }, _.on = function() {
            "en" == t.getConf("lang") && $(".startLotteryBtn").css({
                width: "227px"
            }), t.user._isReady && t.user.pull(), t.user.lotteryPull(), $(".lotteryLayer").show(), this.initAwardLottery()
        }, _.initAwardLottery = function() {
            var e = this;
            return this._conf.award_list ? (this._award_category_id || (this._award_category_id = this._conf.award_list[0].id), $('#awardCategoryBox li[data-category_id="' + this._award_category_id + '"]').removeClass("hidden").siblings().addClass("hidden"), this._bindedAwardSlide || (this._bindedAwardSlide = !0, t.sub("key.up.down, key.down.down", function(r) {
                if ("lottery" == t.getState()) {
                    var a, i = $('#awardCategoryBox li[data-category_id="' + e._award_category_id + '"]');
                    a = "key.up.down" == r ? i.prev() : i.next(), a.length && (e._award_category_id = a.data("category_id"), a.removeClass("hidden").siblings().addClass("hidden"), g(), d())
                }
            })), void 0) : (t.log("awardlottery no award_list"), void 0)
        }, _.initPlay = function() {
            var e = t.user.getAwardLotteryedIds(this._award_category_id);
            if (this._playIsInited) {
                var r = $.extend([], e || []);
                if (0 == r.length) this._playList = [], this._playedIdx = -1, $(".winUserList").html(""), d();
                else {
                    if (0 == this._playList.length) this._playList = r, this._playedIdx = -1;
                    else
                        for (var a = this._playList.slice(this._playedIdx + 1), i = 0; i < a.length; i++) - 1 != t.inArray(a[i], r) && -1 == t.inArray(a[i], this._playList) && this._playList.push(a[i]);
                    for (var i = 0; i < r.length; i++) - 1 == t.inArray(r[i], this._playList) && this._playList.push(r[i]);
                    for (var i = 0; i < this._playList.length; i++) - 1 == t.inArray(this._playList[i], r) && ($('.winUserList li[data-id="' + this._playList[i] + '"]').remove(), $(".lotteryLayer .lotteryName").attr("data-id") == this._playList[i] && d())
                }
                return m($(".winUserList li").length), c(), !1
            }
            this._playList = $.extend([], e || []), this._playedIdx = this._playList.length - 1, clearInterval(this._playeTimer);
            var n = this;
            this._playeTimer = setInterval(function() {
                if (n._playedIdx >= n._playList.length) return t.DEBUG && t.log("lottery playtimer not user to play"), void 0;
                n._playedIdx++;
                var e = n._playList[n._playedIdx];
                return e ? (n.playStart(), setTimeout(function() {
                    n.playStop();
                    var r = t.user.info(e);
                    r && (g(r), y(r), m($(".winUserList li").length), c())
                }, 2e3), void 0) : (n._playedIdx--, t.DEBUG && t.log("lottery playtimer not user to play tmpId empty"), void 0)
            }, 3e3), this._playIsInited = !0
        }, _.playStart = function() {
            clearInterval(this._lotterySlaveTimer), this._lotterySlaveTimer = setInterval(function() {
                var e = t.user.random();
                e && y(e)
            }, 45)
        }, _.playStop = function() {
            clearInterval(this._lotterySlaveTimer), this._lotterySlaveTimer = null
        }, _.saveAwards=function(){
            var awards = t.user.getAwardLotteryedIds(this._award_category_id);

            alert("保存获奖者"+awards);
        };
        var p = null,
            L = null,
            v = !1,
            w = !1,
            B = 0,
            b = !1,
            x = null,
            I = null;
        $(function() {
            e()
        })
    }
}(wxscreen);
