!function (t) {
    if (!t.rate) {
        var e = t.rate = {};
        e._old_rate_info = null, e._rate_info = null, e._conf = {join_count_time: 5e3}, e.init = function (t) {
            this._conf = $.extend(this._conf, t || {}), this.bindEvent()
        }, e.bindEvent = function () {
            var e = this;
            t.sub("key.80.down", function () {
                "rate" != t.getState() ? t.setState("rate") : t.setState("message")
            }), $(".rateOpBtn").click(function () {
                var i = e.getPlayerInfo(e.getCurrentPlayerId()), r = $(this).attr("data-progress");
                if (!i && 1 == e._rate_info.rate_show_type)return t.log(".rateOpBtn click: playerInfo empty"), void 0;
                if (10 == r)return 2 == e._rate_info.rate_show_type ? (e.showRank(), void 0) : (e.showScore(i), $(this).hide(), e.isRateComplete() && $("#rateShowRankBtn").show(), void 0);
                var n = {rate_id: e._rate_info.id, player_id: i ? i.id : 0, progress: r};
                $.post(t.url("rate/change_player_state"), n, function (i) {
                    if ("ok" == i.info) {
                        if (2 == e._rate_info.rate_show_type)return e.setCurrent(i.rate_info), void 0;
                        i.player_info && e.setPlayerInfo(i.player_info), i.player_info && 5 == i.player_info.progress && 1 == e._rate_info.is_show_join_num ? ($("#rateJoinCountBox").css("visibility", "visible"), $("#rateJoinCount").text(i.player_info.join_count), e.startSyncJoinCount()) : (e.stopSyncJoinCount(), $("#rateJoinCountBox").css("visibility", "hidden"))
                    } else t.showMsg(i.info)
                }, "json").error(function () {
                    t.showMsg("网络错误，请刷新重试")
                })
            }), $("#rateShowRankBtn").click(function () {
                e.showRank(), $("#rateShowPlayer").show(), $(this).hide(), $(".rateOpBtn").hide()
            }), $("#rateShowPlayer").click(function () {
                $("#ratePlayer").show().siblings().hide(), $("#rateShowRankBtn").show(), $(this).hide(), e.syncPlayerState(e.getCurrentPlayerLi())
            })
        }, e.startSyncJoinCount = function () {
            var e = this;
            this.stopSyncJoinCount(), this._joinCountTimer = setInterval(function () {
                var i = e._rate_info ? e._rate_info.id : 0, r = e.getCurrentPlayerId();
                if (!i)return t.log("join_count pull failed: rate_id = 0"), void 0;
                var n = e.getPlayerInfo(r);
                return n && 10 == n.progress && !e.isInResult() ? (t.log("startSyncJoinCount: playerInfo not need sync", n), void 0) : (e.isInResult() && (r = 0), e._joinCountAjaxObj = $.post(t.url("rate/get_join_count"), {
                    rate_id: i,
                    player_id: r
                }, function (i) {
                    if ("ok" == i.info) {
                        var r = e.getCurrentPlayerId();
                        (r == i.player_id || e.isInResult()) && $("#rateJoinCount").text(i.count)
                    } else t.log("join_count pull failed: json=", i);
                    e._joinCountAjaxObj = null
                }, "json").error(function () {
                    t.log("join_count pull failed: ajax_error"), e._joinCountAjaxObj = null
                }), void 0)
            }, this._conf.join_count_time)
        }, e.stopSyncJoinCount = function () {
            clearInterval(this._joinCountTimer), this._joinCountTimer = null, this._joinCountAjaxObj && (this._joinCountAjaxObj.abort(), this._joinCountAjaxObj = null)
        }, e.isRateComplete = function () {
            if (2 == this._rate_info.rate_show_type)return 10 == this._rate_info.progress ? !0 : !1;
            for (var t = 0; t < this._rate_info.player_list.length; t++)if (10 != this._rate_info.player_list[t].progress)return !1;
            return !0
        }, e.showRank = function () {
            this.renderRank(), $("#rateTopBox").show(), $("#rateResult").show().siblings().hide(), $(".rateOpBtn").hide()
        }, e.generateRankList = function (t) {
            for (var e, i, r, n = 0, o = 0; o < t.length; o++)e = t[o].score + "", -1 != e.indexOf(".") && (i = e.split("."), r = i[1].length, r > n && (n = r)), t[o].score_scale_int = t[o].score;
            if (n > 0) {
                for (var a = "1", o = 0; n > o; o++)a += "0";
                a = parseInt(a), this._p = a;
                for (var o = 0; o < t.length; o++)t[o].score_scale_int = t[o].score * a
            }
            return t
        }, e.renderRank = function () {
            var t = this._rate_info.player_list;
            t = this.generateRankList(t);
            for (var e = [], i = 0; i < t.length; i++) {
                var r = t[i].score_scale_int + "." + t[i].id;
                e.push(r)
            }
            var n = [], o = [], a = "";
            for (1 == this._rate_info.result_order ? a = "shift" : (e.sort(function (t, e) {
                return parseFloat(t) < parseFloat(e) ? -1 : 1
            }), this._max_score = e[e.length - 1], this._max_score = this._max_score.split("."), this._max_score = this._p ? this._max_score[0] / this._p : this._max_score[0], a = 2 == this._rate_info.result_order ? "shift" : "pop"); e.length;) {
                var s = e[a](), l = s.split(".");
                n.push(l[1]), o.push(l[0])
            }
            this.clearRankDom();
            for (var h = 0, _ = 0, i = 0; i < n.length; i++)_ != o[i] && h++, _ = o[i], this.addRankDomOne(n[i], h);
            return this
        }, e.addRankDomOne = function (t, e) {
            var i = this.getPlayerInfo(t), r = "", n = this.getScoreTotal();
            1 == this._rate_info.result_stat_type && (n = this._max_score);
            var o = i.score / n * 200, a = e > 9 ? 9 : e;
            r = '      <td>         <p class="score-num2"><em>' + i.score + '</em>分</p>         <p class="zhu zhu' + a + '" style="height:' + o + 'px;"><em>第' + e + "名</em></p>       </td>", $("#rateResultColumnBox").append(r), r = '      <td>         <span class="rate-avatar2"><img src="' + i.cover_url + '" alt=""></span>         <p class="rate-name">' + i.title + "</p>       </td>", $("#rateResultNameBox").append(r)
        }, e.clearRankDom = function () {
            return $("#rateResultColumnBox").html(""), $("#rateResultNameBox").html(""), this
        }, e.showScore = function (t) {
            this.renderPlayerOne(t);
            for (var e = $('#ratePlayerList li[data-id="' + t.id + '"]'), i = 0; i < this._rate_info.option_list.length; i++) {
                var r = this._rate_info.option_list[i], n = e.find('.rateOptionOneBox[data-id="' + r.id + '"]'), o = t.option_score_list[r.id];
                if (1 == this._rate_info.result_stat_type)var a = r.score * t.join_count; else var a = r.score;
                this.setScore(a, o, n.find(".rateScoreOption"))
            }
            var a = this.getScoreTotal();
            1 == this._rate_info.result_stat_type && (a *= t.join_count), this.setScore(a, t.score, e.find(".rateScoreTotal"))
        }, e.setScore = function (t, e, i) {
            if (e || (e = 0), t)var r = e / t; else var r = 0;
            var n, o, a = 360 * r;
            180 > a ? (n = a, o = 0) : (n = 180, o = a - n), n = -(180 - n), o = -(180 - o), i.show();
            var s = i.find(".pie1"), l = i.find(".pie2");
            s.css("rotate", "-180deg"), l.css("rotate", "-180deg"), s.transition({
                rotate: n + "deg",
                easing: "linear",
                complete: function () {
                    l.transition({
                        rotate: o + "deg", easing: "linear", complete: function () {
                            i.find(".remainScore").text(e)
                        }
                    })
                }
            })
        }, e.getScoreTotal = function () {
            for (var t = 0, e = 0; e < this._rate_info.option_list.length; e++)t += parseInt(this._rate_info.option_list[e].score);
            return t
        }, e.setPlayerInfo = function (t) {
            for (var e = 0; e < this._rate_info.player_list.length; e++)if (this._rate_info.player_list[e].id == t.id) {
                this._rate_info.player_list[e] = t;
                var i = this.getCurrentPlayerId();
                i == t.id && this.syncPlayerState(this.getCurrentPlayerLi())
            }
        }, e.showLoading = function () {
            $("#rateTopBox").hide(), $("#rateLoading").slideDown().siblings().hide()
        }, e.isInLoading = function () {
            return $("#rateLoading:visible").length
        }, e.isInPlayer = function () {
            return $("#ratePlayer:visible").length
        }, e.isInResult = function () {
            return $("#rateResult:visible").length
        }, e.isInNotice = function () {
            return $("#rateNotice:visible").length
        }, e.getCurrentPlayerLi = function () {
            var t = $("#ratePlayerList li:eq(0)");
            return t.length ? t : null
        }, e.getCurrentPlayerId = function () {
            var t = $("#ratePlayerList li:eq(0)");
            return t.length ? t.attr("data-id") : 0
        }, e.showNotice = function (t, e, i) {
            e = e || "确定", $("#rateNoticeMsg").html(t), $("#rateNoticeBtn").html(e).unbind("click"), i && $("#rateNoticeBtn").bind("click", i), $("#rateNotice").fadeIn().siblings().hide()
        }, e.showPlayer = function () {
            $("#rateTopBox").show(), $("#ratePlayer").fadeIn().siblings().hide()
        }, e.pull = function () {
            var e = this;
            $.post(t.url("rate/current"), function (i) {
                return "ok" != i.info ? (t.showMsg(i.info), void 0) : (e.setCurrent(i.rate_info), void 0)
            }, "json").error(function () {
                t.showMsg("网络错误，请刷新重试")
            })
        }, e.setCurrent = function (t) {
            var e = this;
            return this._old_rate_info = this._rate_info, this._rate_info = t, this._rate_info ? (this.render(), void 0) : (this.showNotice("当前没有正在进行的评分活动", "刷新", function () {
                e.on()
            }), void 0)
        }, e.renderWhole = function () {
            for (var t = "", e = 0; e < this._rate_info.player_list.length; e++) {
                var i = this._rate_info.player_list[e];
                t += '              <li>                 <span class="num left">' + (e + 1) + '</span>                  <span class="avatar2 left"><img src="' + i.cover_url + '" alt=""></span>                  <div class="intro2 left">                    <h4 class="rate-name2">' + i.title + '</h4>                    <p class="msg-rate6">简介，<span>' + i.intro + "</span></p>                  </div>                </li>"
            }
            $("#rateAllPlayerList").html(t)
        }, e.showWholePlayer = function () {
            $("#rateTopBox").show(), $('.rateOpBtn[data-progress="' + this._rate_info.progress + '"]').show().siblings("a").hide(), $("#rateAllPlayer").show().siblings().hide(), 1 == this._rate_info.is_show_join_num ? ($("#rateJoinCountBox").css("visibility", "visible"), $("#rateJoinCount").text(this._rate_info.join_count), this.startSyncJoinCount()) : $("#rateJoinCountBox").css("visibility", "hidden")
        }, e.render = function () {
            if (this.renderBasic(), 2 == this._rate_info.rate_show_type)return 10 == this._rate_info.progress ? (1 == this._rate_info.is_show_join_num ? ($("#rateJoinCountBox").css("visibility", "visible"), $("#rateJoinCount").text(this._rate_info.join_count), this.startSyncJoinCount()) : $("#rateJoinCountBox").css("visibility", "hidden"), this.showRank()) : (this.renderWhole(), this.showWholePlayer()), void 0;
            var t = this.renderPlayer();
            t && (this.showPlayer(), this.initPlayerScroll()), this.syncPlayerState(this.getCurrentPlayerLi())
        }, e.renderBasic = function () {
            return this._rate_info ? ($("#rateJoinCount").html(this._rate_info.join_count), $("#rateTopBox .rate-tit").html(this._rate_info.title), $("#rateJoinTip").html(this._rate_info.join_tip), this) : void 0
        }, e.initPlayerScroll = function () {
            var t = this;
            $("#ratePlayerList").trigger("destroy"), $("#ratePlayerList").carouFredSel({
                infinite: !1,
                circular: !1,
                scroll: {
                    items: 1, duration: 500, pauseOnHover: !0, onAfter: function (e) {
                        t.afterPlayerScroll(e)
                    }
                },
                auto: !1,
                prev: {button: ".prev-rate", key: "left"},
                next: {button: ".next-rate", key: "right"}
            })
        }, e.afterPlayerScroll = function (t) {
            var e = $(t.items.visible[0]);
            this.syncPlayerState(e)
        }, e.syncPlayerState = function (e) {
            var i = e.attr("data-id"), r = this.getPlayerInfo(i);
            if (!r)return t.log("syncPlayerState failed: playerInfo not found", r), void 0;
            if ($('.rateOpBtn[data-progress="' + r.progress + '"]').show().siblings(".rateOpBtn").hide(), e.find(".rateScoreTotal:visible").length && $('.rateOpBtn[data-progress="10"]').hide(), this.isRateComplete() && !this.isInResult() ? $("#rateShowRankBtn").show() : $("#rateShowRankBtn").hide(), 1 == this._rate_info.is_show_join_num) {
                var n = this.getCurrentPlayerId();
                n == i && ($("#rateJoinCountBox").css("visibility", "visible"), $("#rateJoinCount").text(r.join_count)), this.startSyncJoinCount()
            } else $("#rateJoinCountBox").css("visibility", "hidden");
            this.isInPlayer() || $(".rateOpBtn").hide()
        }, e.getPlayerInfo = function (t) {
            if (!t)return null;
            for (var e = 0; e < this._rate_info.player_list.length; e++)if (this._rate_info.player_list[e].id == t)return this._rate_info.player_list[e];
            return null
        }, e.needRenderAllPlayer = function () {
            var t = [], e = [];
            $.each($("#ratePlayerList li"), function () {
                t.push(parseInt($(this).attr("data-id")))
            });
            for (var i = 0; i < this._rate_info.player_list.length; i++)e.push(parseInt(this._rate_info.player_list[i].id));
            if (e.length != t.length)return !0;
            e.sort(), t.sort();
            for (var i = 0; i < e.length; i++)if (e[i] != t[i])return !0;
            return !1
        }, e.renderPlayer = function () {
            var t = this.needRenderAllPlayer();
            if (t) {
                for (var e = "", i = 0; i < this._rate_info.player_list.length; i++)e += this.renderPlayerOne(this._rate_info.player_list[i], !0);
                $("#ratePlayerList").html(e)
            } else for (var i = 0; i < this._rate_info.player_list.length; i++)this.renderPlayerOne(this._rate_info.player_list[i], !1);
            return t
        }, e.renderPlayerOne = function (t, e) {
            var i = $('#ratePlayerList li[data-id="' + t.id + '"]');
            if (i.length && !e) {
                i.find(".ratePlayerCover").attr("src", t.cover_url), i.find(".ratePlayerTitle").html(t.title), i.find(".ratePlayerSn").html(t.sn), i.find(".ratePlayerIntro").html(t.intro), i.find(".rateScoreTotal").attr("data-score", t.score);
                var r = this.renderOptionHtml(t);
                return i.find("dd").remove(), i.find("dt").after(r), i.find(".rateScoreTotal").hide(), void 0
            }
            var r = this.renderOptionHtml(t), n = '      <li data-id="' + t.id + '">        <dl>           <dt>             <div class="clearfix">               <div class="avatar left"><img class="ratePlayerCover" src="' + t.cover_url + '" alt=""></div>               <div class="intro">                 <h2 class="part-tit ratePlayerTitle">' + t.title + '</h2>                 <p class="msg-rate3 ratePlayerSn">编号：<em>' + t.sn + '</em></p>                 <p class="msg-rate4 ratePlayerIntro">简介：<span>' + t.intro + '</span></p>                 <div class="score-total score-show rateScoreTotal hidden" data-score="' + t.score + '">                   <div class="hold hold1">                     <div class="pie pie1"></div>                   </div>                   <div class="hold hold2">                     <div class="pie pie2"></div>                   </div>                   <div class="bg"> </div>                   <div class="score-num"><span class="remainScore">0</span><em>总分</em></div>                 </div>               </div>             </div>           </dt>           ' + r + "         </dl>       </li>";
            return n
        }, e.renderOptionHtml = function (t) {
            for (var e = "", i = 0; i < this._rate_info.option_list.length; i++) {
                var r = this._rate_info.option_list[i], n = t.option_score_list[r.id];
                e += this.renderOptionHtmlOne(r, i + 1, n)
            }
            return e
        }, e.renderOptionHtmlOne = function (t, e, i) {
            i = i || "";
            var r = '      <dd data-id="' + t.id + '" class="rateOptionOneBox">         <p class="item"><em class="rateOptionViewOrder">' + e + '、</em><span class="rateOptionTitle">' + t.title + '</span></p>          <div class="score-show rateScoreOption hidden">            <div class="hold hold1">              <div class="pie pie1"></div>            </div>            <div class="hold hold2">              <div class="pie pie2"></div>            </div>            <div class="bg"> </div>            <div class="score-num"><span class="remainScore">0</span></div>          </div>        </dd>';
            return r
        }, e.on = function () {
            this._rate_info || this.showLoading(), $("#rateLayer").fadeIn(), this.pull()
        }, e.off = function () {
            $("#rateLayer").hide(), this.stopSyncJoinCount()
        }, t.registerState("rate", e)
    }
}(wxscreen);